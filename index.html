<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Study Pop</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
  margin:0; padding:20px; font-family:system-ui;
  background: linear-gradient(135deg,#ffdde1,#ee9ca7);
  text-align:center;
}

h1 { color:#fff; }

.card {
  background:#fff;
  border-radius:20px;
  padding:20px;
  margin-bottom:20px;
  box-shadow:0 10px 20px rgba(0,0,0,.15);
}

input {
  width:80%; padding:12px; font-size:16px;
  border-radius:12px; border:1px solid #ccc;
}

button {
  margin-top:10px; padding:12px 20px;
  font-size:16px; border:none; border-radius:30px;
  background:#ff7aa2; color:#fff; cursor:pointer;
}
button:disabled { background:#ccc; cursor:default; }

.stat { font-size:18px; margin:6px 0; }

ul { list-style:none; padding:0; max-height:180px; overflow-y:auto; }
li { font-size:14px; padding:4px; }

.tabs button { margin:5px; background:#ffd6e8; color:#333; }

.hidden { display:none; }

#chartContainer { width:100%; height:400px; position:relative; }
#weekNav { margin:10px 0; }
</style>
</head>

<body>

<h1>ğŸ“š Study Pop</h1>

<!-- å‹‰å¼·è¨˜éŒ²å…¥åŠ› -->
<div class="card">
  <h2>å‹‰å¼·æ™‚é–“ã‚’è¨˜éŒ²</h2>
  <input type="number" id="minutes" placeholder="ä½•åˆ†å‹‰å¼·ã—ãŸï¼Ÿ">
  <br>
  <button onclick="addStudy()">è¨˜éŒ²ã™ã‚‹</button>
</div>

<!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
<div class="card">
  <h2>ğŸ“Š ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h2>
  <div class="stat" id="total">åˆè¨ˆï¼š0 åˆ†</div>
  <div class="stat" id="month">ä»Šæœˆï¼š0 åˆ†</div>
  <div class="stat" id="streak">ğŸ”¥ é€£ç¶šï¼š0 æ—¥</div>
</div>

<!-- å±¥æ­´ / ã‚°ãƒ©ãƒ• -->
<div class="card">
  <div class="tabs">
    <button onclick="show('history')">ğŸ“… å±¥æ­´</button>
    <button onclick="show('graph')">ğŸ“ˆ ã‚°ãƒ©ãƒ•</button>
  </div>

  <!-- å±¥æ­´ -->
  <div id="history">
    <ul id="historyList"></ul>
  </div>

  <!-- ã‚°ãƒ©ãƒ• -->
  <div id="graph" class="hidden">
    <div id="weekNav">
      <button id="prevWeekBtn" onclick="prevWeek()">â¬… å‰ã®é€±</button>
      <button id="nextWeekBtn" onclick="nextWeek()">æ¬¡ã®é€± â¡</button>
    </div>
    <div id="chartContainer">
      <canvas id="chart"></canvas>
    </div>
  </div>
</div>

<script>
const KEY = "study-pop-data";
let currentWeekOffset = 0; // 0 = ä»Šé€±, -1 = å…ˆé€±, -2 = 2é€±é–“å‰ ...

// ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿/ä¿å­˜
function load() { return JSON.parse(localStorage.getItem(KEY)) || []; }
function save(data) { localStorage.setItem(KEY, JSON.stringify(data)); }

// å‹‰å¼·æ™‚é–“è¿½åŠ 
function addStudy() {
  const min = Number(document.getElementById("minutes").value);
  if(!min) return;
  const data = load();
  const today = new Date().toISOString().slice(0,10);
  data.push({date:today,min});
  save(data);
  document.getElementById("minutes").value="";
  render();
}

// ç”»é¢æç”»
function render() {
  const data = load();

  // åˆè¨ˆ / ä»Šæœˆ
  let total=0, month=0;
  const nowMonth = new Date().toISOString().slice(0,7);
  const days = [...new Set(data.map(d=>d.date))].sort();
  data.forEach(d=>{
    total += d.min;
    if(d.date.startsWith(nowMonth)) month += d.min;
  });
  document.getElementById("total").innerText = `åˆè¨ˆï¼š${total} åˆ†`;
  document.getElementById("month").innerText = `ä»Šæœˆï¼š${month} åˆ†`;

  // é€£ç¶šæ—¥æ•°
  let streak=0;
  for(let i=days.length-1;i>=0;i--){
    const diff = (new Date() - new Date(days[i]))/86400000;
    if(diff < streak + 1) streak++;
    else break;
  }
  document.getElementById("streak").innerText = `ğŸ”¥ é€£ç¶šï¼š${streak} æ—¥`;

  // å±¥æ­´ãƒªã‚¹ãƒˆ
  const historyList = document.getElementById("historyList");
  historyList.innerHTML="";
  data.slice().reverse().forEach(d=>{
    const li = document.createElement("li");
    li.textContent = `${d.date}ï¼š${d.min} åˆ†`;
    historyList.appendChild(li);
  });

  drawChart(data, currentWeekOffset);
  updateButtons();
}

// ã‚°ãƒ©ãƒ•æç”»
let chart;
function drawChart(data, weekOffset){
  const weekNames = ["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"];
  const labels = [];
  const values = [];

  const today = new Date();
  const sunday = new Date(today);
  sunday.setDate(today.getDate() - today.getDay() + (weekOffset*7)); // ä»Šé€± + offset

  for(let i=0;i<7;i++){
    const dt = new Date(sunday);
    dt.setDate(sunday.getDate() + i);
    const yyyy = dt.getFullYear();
    const mm = dt.getMonth()+1;
    const dd = dt.getDate();
    const dateStr = `${yyyy}-${String(mm).padStart(2,'0')}-${String(dd).padStart(2,'0')}`;
    labels.push(`${weekNames[dt.getDay()]}\n${mm}/${dd}`);
    const dayData = data.filter(d=>d.date===dateStr).reduce((sum,x)=>sum+x.min,0);
    values.push(dayData);
  }

  if(chart) chart.destroy();
  chart = new Chart(document.getElementById("chart"), {
    type:"bar",
    data:{ labels, datasets:[{label:"å‹‰å¼·æ™‚é–“ï¼ˆåˆ†ï¼‰",data:values,backgroundColor:"#ff8fab",barPercentage:0.6,categoryPercentage:0.7}] },
    options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:true } }, scales:{ y:{ beginAtZero:true, ticks:{ stepSize:5 } } } }
  });
}

// é€±ç§»å‹•
function prevWeek(){ currentWeekOffset--; render(); }
function nextWeek(){ currentWeekOffset++; render(); }

// æ¬¡é€±ãƒœã‚¿ãƒ³ã®ç„¡åŠ¹åŒ–
function updateButtons(){
  const nextBtn = document.getElementById("nextWeekBtn");
  nextBtn.disabled = currentWeekOffset >= 0; // ä»Šé€±ã‚ˆã‚Šæœªæ¥ã¯ç„¡åŠ¹
}

// å±¥æ­´ / ã‚°ãƒ©ãƒ•åˆ‡æ›¿
function show(id){
  document.getElementById("history").classList.add("hidden");
  document.getElementById("graph").classList.add("hidden");
  document.getElementById(id).classList.remove("hidden");
}

// åˆå›æç”»
render();
</script>

</body>
</html>
