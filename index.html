<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Study Pop</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
html, body { margin:0; padding:0; height:100%; font-family:system-ui; background:linear-gradient(135deg,#ffdde1,#ffb6c1); }
body { display:flex; flex-direction:column; align-items:center; justify-content:flex-start; overflow-y:auto; text-align:center; position:relative; }

h1 { color:#fff; margin:10px 0; }

.card {
  background:#fff; border-radius:30px; padding:20px; margin:8px 0;
  box-shadow:0 10px 25px rgba(0,0,0,.15); width:95%; max-width:500px; flex-shrink:0;
}

input { width:65%; padding:12px; font-size:16px; border-radius:15px; border:1px solid #ccc; }

button { margin-top:6px; padding:14px 28px; font-size:16px; border:none; border-radius:30px; background:#ff85b3; color:#fff; cursor:pointer; }
button:disabled { background:#ccc; cursor:default; }

.stat { font-size:16px; margin:5px 0; }

ul { list-style:none; padding:0; max-height:120px; overflow-y:auto; margin:0; }
li { font-size:14px; padding:3px 0; }

.tabs button { margin:3px; background:#ffc0d4; color:#333; }

.hidden { display:none; }

#chartContainer { width:100%; height:320px; position:relative; overflow:hidden; }
#weekNav { margin:5px 0; }

/* ç”»é¢å…¨ä½“ã«æ¼”å‡ºè¡¨ç¤º */
#effectContainer {
  position: fixed;
  top:0; left:0;
  width:100vw; height:100vh;
  pointer-events:none;
  overflow: visible;
  z-index: 9999;
}

.star { position:absolute; animation:fly 1s linear forwards; }
@keyframes fly { 0%{opacity:1; transform:translateY(0) rotate(0deg);} 100%{opacity:0; transform:translateY(-150px) rotate(360deg);} }

</style>
</head>
<body>

<h1>ğŸ“š Study Pop</h1>

<div class="card">
  <h2>å‹‰å¼·æ™‚é–“ã‚’è¨˜éŒ²</h2>
  <input type="number" id="minutes" placeholder="ä½•åˆ†å‹‰å¼·ã—ãŸï¼Ÿ">
  <br>
  <button onclick="addStudy()">è¨˜éŒ²ã™ã‚‹</button>
</div>

<div class="card">
  <h2>ğŸ¯ 1æ—¥ã®ç›®æ¨™è¨­å®š</h2>
  <input type="number" id="goalInput" placeholder="ç›®æ¨™åˆ†æ•°">
  <button onclick="setGoal()">è¨­å®š</button>
  <div class="stat">ç›®æ¨™ï¼š<span id="goalDisplay">æœªè¨­å®š</span> åˆ†</div>
</div>

<div class="card">
  <h2>ğŸ“Š ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h2>
  <div class="stat" id="total">åˆè¨ˆï¼š0 åˆ†</div>
  <div class="stat" id="month">ä»Šæœˆï¼š0 åˆ†</div>
  <div class="stat" id="streak">ğŸ”¥ é€£ç¶šï¼š0 æ—¥</div>
</div>

<div class="card">
  <div class="tabs">
    <button onclick="show('history')">ğŸ“… å±¥æ­´</button>
    <button onclick="show('graph')">ğŸ“ˆ ã‚°ãƒ©ãƒ•</button>
  </div>

  <div id="history">
    <ul id="historyList"></ul>
  </div>

  <div id="graph" class="hidden">
    <div id="weekNav">
      <button id="prevWeekBtn" onclick="prevWeek()">â¬… å‰ã®é€±</button>
      <button id="nextWeekBtn" onclick="nextWeek()">æ¬¡ã®é€± â¡</button>
    </div>
    <div id="chartContainer">
      <canvas id="chart"></canvas>
    </div>
  </div>
</div>

<!-- ç”»é¢å…¨ä½“ã®æ¼”å‡ºã‚³ãƒ³ãƒ†ãƒŠ -->
<div id="effectContainer"></div>

<script>
const KEY = "study-pop-data";
const GOAL_KEY = "study-pop-goal";
let currentWeekOffset = 0;

if(!localStorage.getItem(GOAL_KEY)) localStorage.setItem(GOAL_KEY,"0");

if("Notification" in window && Notification.permission !== "granted") {
  Notification.requestPermission();
}

function load(){ return JSON.parse(localStorage.getItem(KEY))||[]; }
function save(data){ localStorage.setItem(KEY,JSON.stringify(data)); }

function setGoal(){
  const g = Number(document.getElementById("goalInput").value);
  if(g>0){ localStorage.setItem(GOAL_KEY,g); document.getElementById("goalDisplay").innerText=g; render(); }
}
function getGoal(){ return Number(localStorage.getItem(GOAL_KEY)) || 0; }

function addStudy(){
  const min = Number(document.getElementById("minutes").value);
  if(!min) return;
  const data = load();
  const today = new Date().toISOString().slice(0,10);
  data.push({date:today,min});
  save(data);
  document.getElementById("minutes").value="";
  render();
  showEffect(min);
  checkGoal();
}

function checkGoal(){
  const goal = getGoal();
  if(goal<=0) return;
  const data = load();
  const today = new Date().toISOString().slice(0,10);
  const sumToday = data.filter(d=>d.date===today).reduce((sum,x)=>sum+x.min,0);
  if(sumToday >= goal){
    showEffect(50,true);
    if("Notification" in window && Notification.permission==="granted"){
      new Notification("ç›®æ¨™é”æˆï¼","ä»Šæ—¥ã®ç›®æ¨™ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸğŸ‰");
    }
  }
}

function showEffect(count,big=false){
  const container = document.getElementById("effectContainer");
  for(let i=0;i<(big?15:5);i++){
    const star = document.createElement("div");
    star.className="star";
    star.style.left=Math.random()*window.innerWidth+"px";
    star.style.top=Math.random()*window.innerHeight+"px";
    star.style.color = big ? ["gold","red","orange","lime","aqua"][Math.floor(Math.random()*5)]:"#ff8fab";
    star.style.fontSize = big ? (20+Math.random()*30)+"px":"24px";
    star.innerText = "â­";
    container.appendChild(star);
    setTimeout(()=>container.removeChild(star),1000);
  }
}

function render(){
  const data = load();
  let total=0, month=0;
  const nowMonth = new Date().toISOString().slice(0,7);
  const days=[...new Set(data.map(d=>d.date))].sort();
  data.forEach(d=>{ total+=d.min; if(d.date.startsWith(nowMonth)) month+=d.min; });
  document.getElementById("total").innerText=`åˆè¨ˆï¼š${total} åˆ†`;
  document.getElementById("month").innerText=`ä»Šæœˆï¼š${month} åˆ†`;

  let streak=0;
  for(let i=days.length-1;i>=0;i--){
    const diff=(new Date()-new Date(days[i]))/86400000;
    if(diff<streak+1) streak++;
    else break;
  }
  document.getElementById("streak").innerText=`ğŸ”¥ é€£ç¶šï¼š${streak} æ—¥`;

  const historyList=document.getElementById("historyList");
  historyList.innerHTML="";
  data.slice().reverse().forEach(d=>{
    const li=document.createElement("li");
    li.textContent=`${d.date}ï¼š${d.min} åˆ†`;
    historyList.appendChild(li);
  });

  drawChart(data,currentWeekOffset);
  updateButtons();
}

let chart;
function drawChart(data,weekOffset){
  const weekNames=["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"];
  const labels=[];
  const values=[];
  const today=new Date();
  const sunday=new Date(today);
  sunday.setDate(today.getDate()-today.getDay() + (weekOffset*7));
  for(let i=0;i<7;i++){
    const dt=new Date(sunday);
    dt.setDate(sunday.getDate()+i);
    const yyyy=dt.getFullYear();
    const mm=dt.getMonth()+1;
    const dd=dt.getDate();
    const dateStr=`${yyyy}-${String(mm).padStart(2,'0')}-${String(dd).padStart(2,'0')}`;
    labels.push(`${weekNames[dt.getDay()]}\n${mm}/${dd}`);
    const dayData = data.filter(d=>d.date===dateStr).reduce((sum,x)=>sum+x.min,0);
    values.push(dayData);
  }
  if(chart) chart.destroy();
  chart=new Chart(document.getElementById("chart"),{
    type:"bar",
    data:{ labels,datasets:[{label:"å‹‰å¼·æ™‚é–“ï¼ˆåˆ†ï¼‰",data:values,backgroundColor:"#ff8fab",barPercentage:0.6,categoryPercentage:0.7}] },
    options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:true } }, scales:{ y:{ beginAtZero:true, ticks:{ stepSize:5 } } } }
  });
}

function prevWeek(){ currentWeekOffset--; render(); }
function nextWeek(){ currentWeekOffset++; render(); }
function updateButtons(){ document.getElementById("nextWeekBtn").disabled = currentWeekOffset>=0; }

function show(id){ document.getElementById("history").classList.add("hidden"); document.getElementById("graph").classList.add("hidden"); document.getElementById(id).classList.remove("hidden"); }

document.getElementById("goalDisplay").innerText=getGoal()>0?getGoal():"æœªè¨­å®š";
render();

</script>
</body>
</html>
